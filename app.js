import express from "express";
import sql from "mssql";
import db from "./db.js";

const app = express();
const port = 5000;

// Basic URL Access
// http://localhost:5000/?id=
app.get("/", (req, res) => {
    let URL_PARAM = String(req.query["id"]);

    // Console.logs that we see only here
    console.log("");
    console.log("New Query:");

    // Check if the ?id=param is a number
    // Uncomment this section below to secure the ID parameter
    // if (isNaN(Number(URL_PARAM))) {
    //     console.log("Invalid Input");
    //     res.send("Nothing Found");
    // }
    // connect to database
    sql.connect(db, (err) => {
        // output error if issue happens in our connection. (/?id=)
        if (err) {
            console.log(err);
            res.send("Nothing Found");
        }

        // create a Request object
        let request = new sql.Request();

        // Creating a insecure query
        let query = `SELECT * FROM people WHERE id = ${URL_PARAM}`;
        console.log(query); // What the URL and query looks like together

        // Send a SQL request to MS SQL Server
        request.query(query, (err, out) => {
            if (err) {
                // output error if any and tell user nothing found
                console.log(err);
                res.send("Nothing Found");
            } else {
                // Return JSON of our query results
                res.send(out);
            }
        });
    });
});

// Node server active on port 5000
app.listen(port, () => {
    console.log(`Example app is listening on port: ${port}`);
});
