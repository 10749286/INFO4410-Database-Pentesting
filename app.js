import express from "express";
import sql from "mssql";
import db from "./db.js";

const app = express();
const port = 5000;

// Node server active on port 5000
app.listen(port, () => {
    console.log(`Example app is listening on port: ${port}`);
});

// Basic URL Access
// http://localhost:5000
app.get("/", async (req, res) => {
    try {
        // Connect to database
        await sql.connect(db);

        // A query that will return all cars
        let query = "SELECT * FROM cars";

        // Console log the query that we passed to the server
        console.log("New Query:");
        console.log(query);
        console.log(""); // Spacing

        // Pass the query to the db server
        let result = await sql.query(query);

        // Return results as JSON
        res.send(result);
    } catch (err) {
        // Output errors
        console.log(err);
        res.send("Nothing Found!");
    }
});

// Vulnerable URL Query
// http://localhost:5000/risk?id=
app.get("/risk", async (req, res) => {
    try {
        // Connect to database
        await sql.connect(db);

        // Get URL ID Parameter
        let URL_PARAM = String(req.query["id"]);

        // A query that will return one car given the ID
        let query = `SELECT * FROM cars WHERE id = ${URL_PARAM}`;

        // Console log the query that we passed to the server
        console.log("New Query:");
        console.log(query);
        console.log(""); // Spacing

        // Pass the query to the db server
        let result = await sql.query(query);

        // Return results as JSON
        res.send(result);
    } catch (err) {
        // Output errors
        console.log(err);
        res.send("Nothing Found!");
    }
});
